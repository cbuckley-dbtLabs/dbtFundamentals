WITH stg_stripe__payments AS (
  SELECT
    *
  FROM ANALYTICS.DBT_CBUCKLEY.STG_STRIPE__PAYMENTS
), formula_7591 AS (
  SELECT
    *,
    CASE
      WHEN PAYMENT_METHOD = 'bank_transfer' AND STATUS = 'success'
      THEN AMOUNT
      ELSE 0
    END AS BANK_TRANSFER_AMOUNT,
    CASE
      WHEN PAYMENT_METHOD = 'credit_card' AND STATUS = 'success'
      THEN AMOUNT
      ELSE 0
    END AS CREDIT_CARD_AMOUNT,
    CASE WHEN PAYMENT_METHOD = 'coupon' AND STATUS = 'success' THEN AMOUNT ELSE 0 END AS COUPON_AMOUNT,
    CASE WHEN PAYMENT_METHOD = 'gift_card' AND STATUS = 'success' THEN AMOUNT ELSE 0 END AS GIFT_CARD_AMOUNT,
    CASE WHEN STATUS = 'success' THEN AMOUNT END AS TOTAL_AMOUNT
  FROM stg_stripe__payments
), aggregation_37e5 AS (
  SELECT
    ORDER_ID,
    SUM(BANK_TRANSFER_AMOUNT) AS BANK_TRANSFER_AMOUNT,
    SUM(CREDIT_CARD_AMOUNT) AS CREDIT_CARD_AMOUNT,
    SUM(COUPON_AMOUNT) AS COUPON_AMOUNT,
    SUM(GIFT_CARD_AMOUNT) AS GIFT_CARD_AMOUNT,
    SUM(TOTAL_AMOUNT) AS TOTAL_AMOUNT
  FROM formula_7591
  GROUP BY
    ORDER_ID
), int_payments_pivoted_to_orders AS (
  SELECT
    *
  FROM aggregation_37e5
)
SELECT
  *
FROM int_payments_pivoted_to_orders